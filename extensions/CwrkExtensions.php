<?php class CwrkExtensions implements IPhpExtension{private $_0;private $_1;private $_2="";private $_3="";private $_4="/templates/main";private $_5=array();private $_6="";public function __construct(){$this->_0=cmsController::getInstance();$_7=$this->_0->getTemplatesDirectory() ."i18n/i18n." .$this->_0->getLang()->getPrefix() .".php";if(is_file($_7)){$this->_1=require($_7);}$_8=$this->_0->getCurrentDomain();$_3=$_8->getHost();$this->_3=$_3;$this->_2=$this->__getSiteProtocol() .$_3;if(mainConfiguration::getInstance()->get("debug","dev-mode")){$this->_2=str_replace(".",".cvvrk.",$this->_2);}$_9=explode("?",$_SERVER["REQUEST_URI"]);$_9=$_9[0];$this->_6=$_9;}public function getName(){return __CLASS__;}public function getFunctions(){return array("getType"=> $this->getType(),"getHieraticalType"=> $this->getHieraticalType(),"getObjectType"=> $this->getObjectType(),"getCurrentUrl"=> $this->getCurrentUrl(),"getSiteProtocol"=> $this->getSiteProtocol(),"getAllParams"=> $this->getAllParams(),"parseData"=> $this->parseData(),"parseDate"=> $this->parseDate(),"parseWysiwig"=> $this->parseWysiwig(),"property"=> $this->property(),"properties"=> $this->properties(),"getTemplate"=> $this->getTemplate(),"getTranslationsJSON"=> $this->getTranslationsJSON(),"dump"=> $this->dump(),"translate"=> $this->translate(),"formatPrice"=> $this->formatPrice(),"link2rel"=> $this->link2rel(),"prepareScopeVars"=> $this->prepareScopeVars(),"setScopeVars"=> $this->setScopeVars(),"getScopeVars"=> $this->getScopeVars(),"getLink"=> $this->getLink(),"getObjectName"=> $this->getObjectName(),"js"=> $this->js(),"macrosCached"=> $this->macrosCached(),"htmlParams"=> $this->htmlParams(),"getTypeGUID"=> $this->getTypeGUID());}public function getType(){return function($_10){return umiObjectTypesCollection::getInstance()->getType($_10);};}public function getHieraticalType(){return function($_11){if(!is_object($_11)||!$_11 instanceof umiHierarchyElement){return false;}return $_11->getTypeId();};}public function getObjectType(){return function($_12){return $this->__getObjectType($_12);};}private function __getObjectType($_12){if(!is_object($_12)){return false;}if($_12 instanceof umiObject){return $_12->getTypeId();}if($_12 instanceof umiHierarchyElement){if($_12=$_12->getObject()){if($_12 instanceof umiObject){return $_12->getTypeId();}}}return false;}public function dump(){return function($_13){echo "<pre>";print_r($_13);echo "</pre>";};}public function getTranslationsJSON(){return function(){$_14=isset($this->_5["lang"])?$this->_5["lang"]:"ru";$_15=require __DIR__ ."./../php/i18n/i18n." .$_14 .".php";$_16=json_encode($_15);return $_16;};}public function __getSiteProtocol(){return getServerProtocol() .'://';}public function getSiteProtocol(){return function(){return $this->__getSiteProtocol();};}public function getCurrentHost(){return $this->_2;}public function getCurrentUrl(){return function(){return $this->__getCurrentUrl();};}private function __getCurrentUrl(){return $this->_2 .$this->_6;}public function getAllParams(){return function(){return array_key_exists(1,$this->_6)?$this->_6[1]:"";};}public function getTemplate(){return function($_17=false){return $this->__getTemplate($_17);};}private function __getTemplate($_17=false){if($_17){return $this->_2 .$this->_4;}return $this->_4;}public function parseData(){return function($_18){return $this->__parseData($_18);};}public function parseDate(){return function($_11){if($_11 instanceof umiDate){return $this->__parseDate($_11);}else{return false;}};}public function resizeContentImages(string $_19,int $_20=980,int $_21=490){$_22=$_20;$_23=$_21;$_19=preg_replace_callback('/<img[^>]+>/i',function($_24)use($_22,$_23,$_20,$_21){$_25=array_shift($_24);$_26=false;if(preg_match_all('/(width|height)="(\d+)"/',$_25,$_27)){$_28=array_pop($_27);$_29=array_pop($_27);$_30=0;$_31=0;foreach($_29 as $_32 => $_33){if($_33 === 'width'){$_30=(int) $_28[$_32];if($_30>$_22)$_26=true;}if($_33 === 'height'){$_31=(int) $_28[$_32];}}if($_26){$_23=floor($_22/($_30/$_31));}else{$_22=$_30;$_23=$_31;}}if(!$_22 &&!$_23){return $_25;}if($_26)$_25=preg_replace_callback('/(width|height)="\d+"/',function($_34)use($_22,$_23){$_33=array_pop($_34);return $_33 .'="' .($_33 === 'width'?$_22:$_23) .'"';},$_25);$_25=preg_replace_callback('/src="(.+?)"/',function($_35)use($_22,$_23,$_20,$_21){$_36=array_pop($_35);$_37=pathinfo($_36);$_38=mb_strtolower($_37['extension']);if(strpos($_36,'images/thumbs')!== false || $_38 === 'svg'){return array_shift($_35);}$_39=($_38 !== 'png')?'0xFFFFFF':'transparent';$_40=$this->macros("custom","imageToFrame",['.' .$_36,$_22,$_23,100,$_39,false]);$_41=$_40['src'];$_42=$_40['small'];return 'src="' .$_42 .'" data-src="' .$_41 .'" data-width="' .$_20 .'" data-height="' .$_21 .'" class="lazy responsive"';},$_25);if(preg_match('/data-nowrap/',$_25,$_43)){return $_25;}if($_22 <= 256){return $_25;}if(preg_match('/data-src="(.+?)"/',$_25,$_35)){$_44=array_pop($_35);return '<a href="' .$_44 .'" class="fancybox" data-fancybox="gallery">' .$_25 .'</a>';}else{return $_25;}},$_19);$_19=preg_replace_callback('/<iframe[^>]+><\/iframe>/i',function($_45){$_46=array_pop($_45);preg_match('/src="(.+?)youtu(.+?)"/',$_46,$_47);if(count($_47)){return '<div class="video-container">' .$_46 .'</div>';}else{return $_46;}},$_19);$_19=preg_replace('/class="\s?"/','',$_19);return $_19;}public function wrapTables(string $_19){$_19=preg_replace_callback('/(<table[^>]*>(?:.|\n)*?<\/table>)/i',function($_48){$_49=array_pop($_48);return '<div class="table-wrapper">' .$_49 .'</div>';},$_19);return $_19;}public function fileLink(string $_19){$_50=false;$_51=[];$_52=$_19;$_19=preg_replace_callback('/<a[^>]+href=\"(.*?)\"[^>]*>(.*?)<\/a>/i',function($_53)use(&$_50,&$_51,$_52){$_54=array_shift($_53);$_55=array_shift($_53);$_56=array_shift($_53);if($_57=$this->getPageByPath($_55)){if($_57 instanceof umiHierarchyElement){$_58=$_57->getObjectTypeId();if(isset($_58)&&!empty($_58)&& intval($_58)>0){$_59=umiObjectTypesCollection::getInstance()->getType($_58);if($_59 instanceof umiObjectType){$_60=$_59->getGUID();if($_60 == 'filemanager-sharedfile'){$_61=$_57->getValue('fs_file');if(!is_object($_61)){return $_52;}$_51=$this->__parseFile($_61);$_54=preg_replace('/\s+class="\."/','',$_54);$_54=preg_replace('/\s+target="\."/','',$_54);$_54=preg_replace('/^\<a/','<a class="icon-file" target="_blank"',$_54);$_54=str_replace($_55,$_51['filepath'],$_54);$_62='Кбайт';$_63=round($_51['size']/1024,2);if($_63>1024){$_62='Мбайт';$_63=round($_63/1024,2);}$_64=' (' .$_63 .' ' .$_62 .')';$_54=str_replace($_56,$_56 .$_64,$_54);}}}}}return $_54;},$_19);return $_19;}public function parseWysiwig(){return function($_19,umiTemplaterPHP $_65){if(!is_string($_19)){return $_19;}$_19=$this->resizeContentImages($_19);$_19=$this->wrapTables($_19);$_19=preg_replace_callback('/\{(\i18n::[a-z\d\.-]+)\}/',function($_66){if(strpos($_66[1],'i18n::')=== 0){return $this->tr(str_replace('i18n::','',$_66[1]));}return '';},$_19);if(strpos($_19,'%')!== false){$_19=preg_replace_callback('/<p>(%.*?%)<\/p>/',function($_66){return count($_66)>1?$_66[1]:$_66[0];},$_19);$_19=preg_replace_callback('/%(\w+)\s(\w+)\((.*?)\)%/',function($_66)use($_65){if(count($_66)=== 4){$_67=$_66[1];$_68=$_66[2];$_69=explode(',',$_66[3]);$_70='modules/' .$_67 .'/' .$_68;$_71='main';try{$_18=$_65->macros($_67,$_68,$_69);if(is_array($_18)){try{return $_65->render($_18,$_70,$_71);}catch(Exception $_72){return '<b>Templating exception:</b> ' .$_72->getMessage() .'<br/> <b>Macros:</b> ' .$_66[0] .'<br/>';}}elseif(is_string($_18)){return $_18;}}catch(Exception $_72){return '<b>Macros call exception:</b> ' .$_72->getMessage() .'<br/> <b>Macros:</b> ' .$_66[0] .'<br/>';}}return $_66[0];},$_19);}$_19=$this->fileLink($_19);return $_19;};}public function property(){$_73=$this;return function($_11,$_74)use($_73){{return $_73->parseDataProperty($_11->getValue($_74));}return false;};}public function properties(){$_73=$this;return function($_11,array $_75)use($_73){$_76=array();foreach($_75 as $_74){$_77=$_11->getValue($_74);$_76[]=$_73->parseDataProperty($_77);}return $_76;};}public function setScopeVars(){return function(array $_78){$this->__setScopeVars($_78);};}private function __setScopeVars(array $_78){foreach($_78 as $_79 => $_80){$this->_5[$_79]=$_80;}}public function prepareScopeVars(){$_73=$this;return function($_81)use($_73){$_81=$_73->__parseData($_81);$_82=isset($_81["data"])?$_81["data"]:array();$_83=array("type"=> $_81["user"]["type"],"id"=> $_81["user"]["id"]);if($_84=umiObjectsCollection::getInstance()->getObject($_83["id"])){$_83["email"]=$_84->getValue("e-mail");}$_85=$_81["lang"];$_9=$this->__getCurrentUrl();$_86=isset($_REQUEST["filter"])?$_REQUEST["filter"]:array();$_87=isset($_REQUEST["q"])?$_REQUEST["q"]:"";$_88=isset($_REQUEST["search_string"])?$_REQUEST["search_string"]:"";$_89=$_81["module"];$_90=$_81["method"];$_91=isset($_81["meta"]["keywords"])?$_81["meta"]["keywords"]:"";$_92=isset($_81["meta"]["description"])?$_81["meta"]["description"]:"";$_93=isset($_81["page"])?$_81["page"]:null;$_94=isset($_81["pageId"])?(int) $_81["pageId"]:0;$_95=$_73->__getCurrentUrl();$_96=$_81["title"];$_97=$_81["header"];$_98=(isset($_93)&&!is_null($_93))?$_93->getName():'';$_99=0;$_100="";$_101=false;$_102=null;$_103=null;$_104=0;$_105="";$_106=null;$_107=0;$_108="";if($_93){$_99=(int) $this->__getObjectType($_93);$_100=$_93->getAltName();$_101=$_93->getIsDefault();$_102=isset($_81["parents"]["page"])?$_81["parents"]["page"]:false;if(is_array($_102)&& count($_102)){$_103=$_102[0];$_104=(int) $_103->getId();$_105=$_103->getAltName();$_109=$_102;$_106=array_pop($_109);$_107=(int) $_106->getId();$_108=$_106->getAltName();unset($_109);}if($_100 === "tag"){$_110=$this->__translate("l-site-name");$_97="{$this->_111("h-pages-with-tag")}: «{$_87}»";$_96="{$_110} - {$_97}";}}$_112=array("page"=> array("id"=> $_94,"obj"=> $_93,"url"=> $_95,"title"=> $_96,"name"=> $_98,"header"=> $_97,"type_id"=> $_99,"alt_name"=> $_100,"is_default"=> $_101,),"domain"=> $this->_3,"host"=> $this->getCurrentHost(),"description"=> $_92,"keywords"=> $_91,"filter"=> $_86,"q_param"=> $_87,"search_string"=> $_88,"module"=> $_89,"method"=> $_90,"data"=> $_82,"user"=> $_83,"lang"=> $_85,"request-uri"=> $_9,'site'=> $this->_2,"isDebug"=> mainConfiguration::getInstance()->get('debug','enabled'),);if($_106){$_112["page"]["parent"]=array("id"=> $_107,"obj"=> $_106,"alt_name"=> $_108);}if($_103){$_112["page"]["ancestor"]=array("id"=> $_104,"obj"=> $_103,"alt_name"=> $_105);}$this->__setScopeVars($_112);};}private function processBasket(){if($_113=cmsController::getInstance()->getModule("emarket")){$_114=$this->__parseData($_113->cart());$_115=array();$_116=array();if(isset($_114["items"])){foreach($_114["items"]as $_117){if($_118=$_117["page"]->getId()){$_115[$_118]=$_117;array_push($_116,$_118);}}}$_114["items"]=$_115;$_114["ids"]=$_116;return $_114;}return false;}public function getScopeVars(){return function(){return $this->_5;};}public function getLink(){return function($_12,$_119=true){if($_12 instanceof umiHierarchyElement){$_120=$_12->_121;if($_119){$_120=$this->_2 .$_120;}return $_120;}return false;};}public function getObjectName(){return function($_12){if(is_object($_12)){return $_12->getName();}return false;};}public function render($_122,$_123){$_124=new umiTemplaterPHP($_123);return $_124->render($_122,$_123);}public function macros($_67,$_125,$_69=[],$_126=[],$_127=[],$_128=0){$_124=new umiTemplaterPHP('');$_129=new ViewPhpExtension($_124);return $_129->macros($_67,$_125,$_69,$_126,$_127,$_128);}public function macrosCached(){return function($_130,$_125,$_69=[],$_128=321408000){$_131=$_130 .'_' .$_125 .'_' .implode('_',$_69);$_132="/$_130/$_125";if($_128>0){if($_133=getCache($_131,$_132)){return $_133;}return putCache($this->macros($_130,$_125,$_69),$_131,$_132,$_128);}return $this->macros($_130,$_125,$_69);};}public function getPageByPath(){return[];}public function getPageById(){return (object)[];}public function getObjectById(){return (object)[];}private function __parseData($_134){if(is_array($_134)){$_135=array();foreach($_134 as $_136 => $_137){if(($_136=$this->parseDataKey($_136))!== false){if(is_array($_137)){if($_136 === "extended"){$_135["properties"]=$this->parseDataProperties($_137);}elseif(preg_match("/items|lines|groups|fields|values|pages/",$_136)){$_138=substr($_136,0,strlen($_136)-1);if(isset($_137["nodes:" .$_138])){$_135[$_136]=$this->__parseData($_137["nodes:" .$_138]);}elseif(isset($_137["nodes:item"])){$_135[$_136]=$this->__parseData($_137["nodes:item"]);}else{$_135[$_136]=$this->__parseData($_137);}}else{$_135[$_136]=$this->__parseData($_137);}}else{if($_136 === "link"){if(preg_match("/^((https?|s?ftp):\/\/)/",$_137)|| strpos($_137,"#")=== 0){$_135[$_136]=$_137;}elseif(strpos($_137,"?")=== 0){$_135[$_136]=$this->_6 .$_137;}else{$_135[$_136]=$this->_2 .$_137;}}else{$_135[$_136]=$_137;}}}}}else{$_135=$_134;}return $_135;}private function parseDataKey($_136){if(is_string($_136)){if($_136 === "class"|| preg_match("/void:|xlink:/",$_136)){return false;}$_136=preg_replace("/@|\+|full:|object:|node:|nodes:|subnodes:|attribute:/","",$_136);}return $_136;}private function parseDataProperties($_139){$_76=array();$_139=$this->__parseData($_139);if(isset($_139["properties"])&& isset($_139["properties"]["property"])){foreach($_139["properties"]["property"]as $_77){$_140=$_77->getName();$_76[$_140]=$this->parseDataProperty($_77);}}else{$_76=$_139;}return $_76;}private function parseDataProperty($_77){if(!is_object($_77)){return $_77;}if($_77 instanceof umiObjectProperty){return $this->parseDataValue($_77->getValue());}else{return $this->parseDataValue($_77);}}private function parseDataValue($_137){if(!is_object($_137)){return $_137;}$_76=array();switch(get_class($_137)){case "umiDate":{$_76=$this->__parseDate($_137);}break;case "umiImageFile":{$_76=$this->__parseImage($_137);}break;case "umiFile":{$_76=$this->__parseFile($_137);}break;}return $_76;}private function __parseDate($_141){$_142=$_141->_142;$_142=intval($_142);$_143=strftime("%e",$_142);$_144=$this->__translate("m-" .strtolower(strftime("%B",$_142)));$_145=strftime("%G",$_142);return array("formatted"=>"{$_143} {$_144} {$_145}","numeric"=> date("Y-m-d",$_142),'timestamp'=> $_142);}private function __parseFile($_146){return $_146->getFilePath(true);}private function __parseImage($_146){$_147=$_146->getFilePath(true);$_148=$_146->getWidth();$_149=$_146->getHeight();return array("src"=> $_147,"width"=> $_148,"height"=> $_149);}public function translate(){return function($_150){return $this->__translate($_150);};}private function __translate($_150){if(array_key_exists($_150,$this->_1)){return $this->_1[$_150];}return preg_replace("/^\w-/","",$_150);}public function formatPrice(){return function($_151){$_151=number_format($_151,2,',',' ');return $_151;};}public function link2rel(){return function($_120){$_152=$this->_5;if(isset($_152["linksIsAbsolute"])){if(isset($_152["linksIsAbsolute"][$this->_3])&& $_152["linksIsAbsolute"][$this->_3]=== false){return preg_replace('/^http(s)?\:/i','',$_120);}}return $_120;};}public function js(){return function($_153){return $this->_js($_153);};}private function _js($_153){$_154=[];switch(gettype($_153)){case 'array':if(isAssoc($_153)){$_154[]='{';$_155=[];foreach($_153 as $_156 => $_157){$_155[]=$_156 .':' .$this->_js($_157);}$_154[]=implode(',',$_155);$_154[]='}';}else{$_154[]='[';$_155=[];foreach($_153 as $_157){$_155[]=$this->_js($_157);}$_154[]=implode(',',$_155);$_154[]=']';}break;case 'float':case 'double':case 'integer':$_154[]=$_153;break;case 'NULL':$_154[]='null';break;default:if(is_numeric($_153))$_154[]=$_153;else $_154[]="'" .preg_replace("/\r|\n/",'--n',$_153) ."'";}return implode('',$_154);}public function htmlParams(){return function($_158){return htmlentities(json_encode($_158,JSON_UNESCAPED_UNICODE));};}public function getTypeGUID(){return function($_159){if(!isset($_159)){return null;}if(empty($_159)){return null;}if(!$_159){return null;}if($_159 instanceof umiObject){return $_159->getTypeGUID();}if($_159 instanceof umiHierarchyElement){$_11=$_159->getObject();if($_11 instanceof umiObject){return $_11->getTypeGUID();}}if(is_numeric($_159)){$_160=$_159;$_161=umiHierarchy::getInstance();$_162=$_161->getElement($_160);if(!($_162 instanceof umiHierarchyElement)){return null;}$_11=$_162->getObject();if($_11 instanceof umiObject){return $_11->getTypeGUID();}}return null;};}public function phoneFormat($_163){$_163=trim($_163);$_164=preg_replace(array('/[\+]?([7|8])[-|\s]?\([-|\s]?(\d{4})[-|\s]?\)[-|\s]?(\d{2})[-|\s]?(\d{2})[-|\s]?(\d{2})/','/[\+]?([7|8])[-|\s]?(\d{4})[-|\s]?(\d{2})[-|\s]?(\d{2})[-|\s]?(\d{2})/','/[\+]?([7|8])[-|\s]?\([-|\s]?(\d{4})[-|\s]?\)[-|\s]?(\d{2})[-|\s]?(\d{2})[-|\s]?(\d{2})/','/[\+]?([7|8])[-|\s]?(\d{4})[-|\s]?(\d{2})[-|\s]?(\d{2})[-|\s]?(\d{2})/','/[\+]?([7|8])[-|\s]?\([-|\s]?(\d{4})[-|\s]?\)[-|\s]?(\d{3})[-|\s]?(\d{3})/','/[\+]?([7|8])[-|\s]?(\d{4})[-|\s]?(\d{3})[-|\s]?(\d{3})/',),array('8 ($2) $3-$4-$5','8 ($2) $3-$4-$5','8 ($2) $3-$4-$5','8 ($2) $3-$4-$5','8 ($2) $3-$4','8 ($2) $3-$4',),$_163);return $_164;}public function getPathById(int $_160){return umiHierarchy::getInstance()->getPathById($_160);}public function getParentByPageId(int $_160){return umiHierarchy::getInstance()->getParent($_160);}}
